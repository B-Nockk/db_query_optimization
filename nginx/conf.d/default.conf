# Environment variables (set via docker-compose or envsubst)
# ${API_HOST} - default: api
# ${API_PORT} - default: 8000
# ${SERVER_NAME} - default: localhost
# ${SSL_ENABLED} - default: false

upstream api_backend {
    server ${API_HOST}:${API_PORT} max_fails=3 fail_timeout=30s;
    keepalive 32;  # Connection pooling
}

# HTTP server (always present)
server {
    listen 80;
    server_name ${SERVER_NAME};

    # Redirect to HTTPS if SSL enabled (handled by docker-compose env)
    # Uncomment when SSL_ENABLED=true
    # return 301 https://$server_name$request_uri;

    # Health check (always accessible via HTTP)
    location /health {
        proxy_pass http://api_backend;
        include /etc/nginx/includes/proxy_headers.conf;
        access_log off;
    }

    # Main application (HTTP)
    location / {
        proxy_pass http://api_backend;
        include /etc/nginx/includes/proxy_headers.conf;

        # Security headers
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options DENY;
        add_header X-XSS-Protection "1; mode=block";
    }
}

# HTTPS server (uncomment when SSL certificates are ready)
# server {
#     listen 443 ssl http2;
#     server_name ${SERVER_NAME};
#
#     # SSL configuration
#     ssl_certificate ${SSL_CERT_PATH};
#     ssl_certificate_key ${SSL_KEY_PATH};
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
#     ssl_prefer_server_ciphers off;
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 10m;
#
#     # HSTS (optional, be careful!)
#     # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
#
#     location /health {
#         proxy_pass http://api_backend;
#         include /etc/nginx/includes/proxy_headers.conf;
#         access_log off;
#     }
#
#     location / {
#         proxy_pass http://api_backend;
#         include /etc/nginx/includes/proxy_headers.conf;
#
#         # Security headers
#         add_header X-Content-Type-Options nosniff;
#         add_header X-Frame-Options DENY;
#         add_header X-XSS-Protection "1; mode=block";
#     }
# }